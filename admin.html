<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Salsa Aguacanero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
        h1, h2 { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="p-6 bg-gray-100 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ðŸ¥‘ Votos Recibidos</h1>
                <p class="text-gray-600">Salsa Aguacanero</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Total Opiniones</div>
                <div id="totalCount" class="text-4xl font-bold text-lime-600">0</div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Promedio Estrellas</h3>
                <p id="avgRating" class="text-3xl font-bold text-gray-800 mt-2">-</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-bold text-gray-700">Entradas Recientes</h2>
                <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">En tiempo real</span>
            </div>

            <div id="reviewsList" class="divide-y divide-gray-100">
                <div class="p-8 text-center text-gray-500 animate-pulse">
                    Cargando datos de la salsa...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // MANTÃ‰N ESTOS IMPORTS CON URL COMPLETA (NO LOS BORRES)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       // La lÃ­nea corregida (correcta):
        import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // AQUÃ PEGAS TU CONFIGURACIÃ“N REAL (REEMPLAZANDO LA LÃNEA DE __firebase_config)
        const firebaseConfig = {
            apiKey: "AIzaSyBqu4PbITJhf5A1i1qOKgAb5kJrZCbZTY0",
            authDomain: "votos-ad55c.firebaseapp.com",
            // IMPORTANTE: AÃ±ade la databaseURL para Realtime Database si no estÃ¡.
            // Usualmente es: https://TU-PROYECTO-default-rtdb.firebaseio.com
            // Puedes encontrarla en la consola de Firebase -> Realtime Database.
            // Si no la pones, a veces falla RTDB.
            databaseURL: "https://votos-ad55c-default-rtdb.firebaseio.com", 
            projectId: "votos-ad55c",
            storageBucket: "votos-ad55c.firebasestorage.app",
            messagingSenderId: "952113141563",
            appId: "1:952113141563:web:e5f37a6e703867ab5dc91e"
        };

        // Inicializa Firebase con TU configuraciÃ³n real
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const VOTES_REF = ref(db, 'salsa_votes'); 

        // 1. AutenticaciÃ³n y Carga de Datos
        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadAdminData();
            }
        });

        function loadAdminData() {
            const reviewsList = document.getElementById('reviewsList');
            const totalCountEl = document.getElementById('totalCount');
            const avgRatingEl = document.getElementById('avgRating');

            const q = query(VOTES_REF, limitToLast(50));

            onValue(q, (snapshot) => {
                if (!snapshot.exists()) {
                    reviewsList.innerHTML = `<div class="p-8 text-center text-gray-400 italic">AÃºn no hay datos.</div>`;
                    totalCountEl.textContent = 0;
                    avgRatingEl.textContent = "-";
                    return;
                }

                const data = snapshot.val(); 
                const votes = Object.values(data);
                votes.reverse(); // Ãšltimos votos primero

                totalCountEl.textContent = votes.length; 

                let html = '';
                let totalStars = 0;
                
                votes.forEach((data) => {
                    totalStars += data.rating;

                    const date = data.timestamp ? new Date(data.timestamp).toLocaleString('es-ES') : 'Reciente';
                    const ratingColor = data.rating >= 4 ? 'text-lime-600 bg-lime-50' : (data.rating <= 2 ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50');

                    html += `
                        <div class="p-4 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-bold text-gray-800">${escapeHtml(data.name)}</span>
                                    <span class="text-xs text-gray-400 ml-2">${date}</span>
                                </div>
                                <div class="px-3 py-1 rounded-full text-sm font-bold ${ratingColor}">
                                    ${data.rating} â˜…
                                </div>
                            </div>
                            ${data.comment ? `<p class="text-gray-600 mt-1 bg-white p-3 rounded border border-gray-100 text-sm">"${escapeHtml(data.comment)}"</p>` : '<span class="text-gray-300 text-xs italic">Sin comentario</span>'}
                        </div>
                    `;
                });

                reviewsList.innerHTML = html;
                avgRatingEl.textContent = (votes.length > 0) ? (totalStars / votes.length).toFixed(1) + ' / 5.0' : '-';

            }, (error) => {
                console.error("Error leyendo RTDB:", error);
                reviewsList.innerHTML = `<div class="p-4 text-red-500 bg-red-50">Error cargando datos.</div>`;
            });
        }

        function escapeHtml(unsafe) {
             return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>